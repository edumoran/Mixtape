<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Mixtape Home</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/style-home.css">

</head>

<body>

    <div class="sidenav">
        <img src="assets/images/logo_no-shadow.png" class="img-fluid mx-auto d-block" id="mixtape">
        <div>
            <h5>PLAYLIST</h5>
            <h2><span id="playlist-name"></span></h2>
            <h5>NUMBER OF TRACKS <span id="playlist-track-count"></span></h5>
            <p id="play-wrapper"><a class="btn" button id="play-pause">PLAY</a></p>
            <img id="qr-code" class="img-fluid mx-auto d-block">
        </div>
    </div>

    <nav class="navbar fixed-top navbar-light" id="navbar">
        <div class="media">
            <img class="align-self-center" id="playlist-image">
            <div class="align-self-center media-body">
                <h2 id="song-playing"></h2>
                <h5 id="artist"></h5>
            </div>
        </div>
    </nav>

    <div class="main">
        <div id="tracks"></div>
    </div>


    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.3/firebase.js"></script>
    <script src="assets/javascript/database.js"></script>
    <script>
        const CONFIG_REF = firebase.database().ref("config");
        const DOWNVOTES_REF = firebase.database().ref("downvotes");
        const PLAYER_REF = firebase.database().ref("player");
        const PLAYLIST_REF = firebase.database().ref("playlist");

        var config = undefined;
        var currentTrackId = undefined;
        var player = undefined;
        var playerId = undefined;
        var playerStatus = undefined;
        var playlistUri = undefined;

        window.onSpotifyWebPlaybackSDKReady = function () {
            resetDownvotes();
            loadConfig();
            listenToDownvotes();
            listenToPlayerStatus();
            listenToPlaylistStatus();
        }

        function loadConfig() {
            CONFIG_REF.once("value", function (snapshot) {
                if (snapshot.val()) {
                    config = snapshot.val();

                    getPlaylistInfo();
                    displayQR();
                    initializePlayer();
                }
            });
        }

        function listenToDownvotes() {
            DOWNVOTES_REF.on("value", function (downvotesSnapshot) {
                if (downvotesSnapshot.val() && downvotesSnapshot.numChildren() > 1) {
                    player.nextTrack();
                    console.log("Song was downvoted!");
                }
                $("#downvotes").text(downvotesSnapshot.numChildren());
            });
        }

        function listenToPlaylistStatus() {
            PLAYLIST_REF.on("value", function (playerSnapshot) {
                getPlaylistInfo();
            });
        }

        function listenToPlayerStatus() {
            PLAYER_REF.on("value", function (playerSnapshot) {
                if (playerSnapshot.val()) {
                    $("#song-playing").text(playerSnapshot.val().song);
                    $("#artist").text(playerSnapshot.val().artist);

                } else {
                    PLAYER_REF.set({
                        paused: true
                    });
                }
            });
        }

        function updatePlayerStatus(status) {
            PLAYER_REF.update(status);
        }

        function getPlaylistInfo() {
            $.ajax({
                url: "https://api.spotify.com/v1/playlists/" + config.spotifyPlaylistId,
                method: 'GET',
                success: function (data, status) {
                    console.log(data);
                    playlistUri = data.uri;
                    $("#playlist-name").text(data.name);
                    $("#playlist-track-count").text(data.tracks.items.length);
                    if (data.images.length > 0) {
                        $("#playlist-image").attr("src", data.images[0].url);
                    }

                    $(".track").remove();

                    for (let i = 0; i < data.tracks.items.length; i++) {
                        let trackInfo = data.tracks.items[i].track;
                        let albumInfo = trackInfo.album;
                        let artistInfo = trackInfo.artists[0];
                        let track = $("<p>")
                            .addClass("track")
                            .append($("<img>").attr("src", albumInfo.images[2].url))
                            .append($("<span>").html(artistInfo.name + " <br/><i>" + trackInfo.name +
                                "</i>"));

                        $("#tracks").append(track);

                        console.log(trackInfo);
                    }
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + config.token);
                }
            });
        }

        function appendTrack(trackInfo) {
            let track = $("<p>");
        }

        function displayQR() {
            let guestURL = 'https://edumoran.github.io/Mixtape/guest.html';
            var queryURL = "http://api.qrserver.com/v1/create-qr-code/?data=" + guestURL + "&size=200x200";
            $("#qr-code").attr("src", queryURL);
        }

        function initializePlayer() {
            player = new Spotify.Player({
                name: 'Mixtape Web Player',
                getOAuthToken: cb => {
                    cb(config.token);
                }
            });

            // Error handling
            player.addListener('initialization_error', ({
                message
            }) => {
                console.error(message);
            });
            player.addListener('authentication_error', ({
                message
            }) => {
                console.error(message);
            });
            player.addListener('account_error', ({
                message
            }) => {
                console.error(message);
            });
            player.addListener('playback_error', ({
                message
            }) => {
                console.error(message);
            });

            // Playback status updates
            player.addListener('player_state_changed', state => {
                console.log("Player state changed", state);
                let current_track = state.track_window.current_track;
                let artist = current_track.artists.map(({
                    name
                }) => name).join(', ');

                let status = {
                    duration: state.duration,
                    paused: state.paused,
                    position: state.position,
                    song: currentTrack.name,
                    artist
                }

                console.log(status);
                if (currentTrackId != currentTrack.id) {
                    resetDownvotes();
                }
                currentTrackId = currentTrack.id
                updatePlayerStatus(status);
            });

            // Ready
            player.addListener('ready', ({
                device_id
            }) => {
                console.log('Ready with Device ID', device_id);
                playerId = device_id;
            });

            // Not Ready
            player.addListener('not_ready', ({
                device_id
            }) => {
                console.log('Device ID has gone offline', device_id);
            });

            // Connect to the player!
            player.connect();
        }

        function resetDownvotes() {
            DOWNVOTES_REF.set({});
        }

        $("#play-pause").click(function () {
            player.getCurrentState().then(state => {
                if (!state) {
                    firstPlay();
                } else {
                    player.togglePlay();
                }
            });
            $(this).toggleClass("playing");
            if ($(this).hasClass("playing")) {
                $(this).text("Pause");
            } else {
                $(this).text("Play");
            }
        });

        function firstPlay() {
            $.ajax({
                url: "https://api.spotify.com/v1/me/player/play?device_id=" + playerId,
                method: 'PUT',
                data: JSON.stringify({
                    context_uri: playlistUri
                }),
                success: function (data, status) {
                    console.log(data);
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + config.token);
                }
            });
        }
    </script>
</body>

</html>