<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Host</title>
    <style>
        .track {
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }

        .track img {
            float: left;
            margin-right: 10px;
            clear: both;
            height: 35px;
        }
    </style>
</head>

<body>
    <h1>Host</h1>
    <p>
        <img id="playlist-image" height="200">
        <img id="qr-code">
    </p>
    <p>
        <p id="song-playing"></p>
        <p>Downvotes: <span id="downvotes"></span></p>
        <button id="play-pause">Play</button>
    </p>
    <h2>Playlist: <span id="playlist-name"></span></h2>
    <h3>Number of tracks: <span id="playlist-track-count"></span></h3>

    <div id="tracks"></div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.3/firebase.js"></script>
    <script src="assets/javascript/database.js"></script>
    <script>
        const CONFIG_REF = firebase.database().ref("config");
        const DOWNVOTES_REF = firebase.database().ref("downvotes");
        const PLAYER_REF = firebase.database().ref("player");
        const PLAYLIST_REF = firebase.database().ref("playlist");

        var config = undefined;
        var currentTrackId = undefined;
        var player = undefined;
        var playerId = undefined;
        var playerStatus = undefined;
        var playlistUri = undefined;

        window.onSpotifyWebPlaybackSDKReady = function () {
            resetDownvotes();
            loadConfig();
            listenToDownvotes();
            listenToPlayerStatus();
            listenToPlaylistStatus();
        }

        function loadConfig() {
            CONFIG_REF.once("value", function (snapshot) {
                if (snapshot.val()) {
                    config = snapshot.val();

                    getPlaylistInfo();
                    displayQR();
                    initializePlayer();
                }
            });
        }

        function listenToDownvotes() {
            DOWNVOTES_REF.on("value", function (downvotesSnapshot) {
                if (downvotesSnapshot.val() && downvotesSnapshot.numChildren() > 1) {
                    player.nextTrack();
                    console.log("Song was downvoted!");
                }
                $("#downvotes").text(downvotesSnapshot.numChildren());
            });
        }

        function listenToPlaylistStatus() {
            PLAYLIST_REF.on("value", function (playerSnapshot) {
                getPlaylistInfo();
            });
        }

        function listenToPlayerStatus() {
            PLAYER_REF.on("value", function (playerSnapshot) {
                if (playerSnapshot.val()) {

                    $("#song-playing").text(`${playerSnapshot.val().song} - ${playerSnapshot.val().artist}`)

                } else {
                    PLAYER_REF.set({
                        paused: true
                    });
                }
            });
        }

        function updatePlayerStatus(status) {
            PLAYER_REF.update(status);
        }

        function getPlaylistInfo() {
            $.ajax({
                url: "https://api.spotify.com/v1/playlists/" + config.spotifyPlaylistId,
                method: 'GET',
                success: function (data, status) {
                    console.log(data);
                    playlistUri = data.uri;
                    $("#playlist-name").text(data.name);
                    $("#playlist-track-count").text(data.tracks.items.length);
                    if (data.images.length > 0) {
                        $("#playlist-image").attr("src", data.images[0].url);
                    }

                    $(".track").remove();

                    for (let i = 0; i < data.tracks.items.length; i++) {
                        let trackInfo = data.tracks.items[i].track;
                        let albumInfo = trackInfo.album;
                        let artistInfo = trackInfo.artists[0];
                        let track = $("<p>")
                            .addClass("track")
                            .append($("<img>").attr("src", albumInfo.images[2].url))
                            .append($("<span>").html(artistInfo.name + " <br/><i>" + trackInfo.name + "</i>"));

                        $("#tracks").append(track);

                        console.log(trackInfo);
                    }
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + config.token);
                }
            });
        }

        function appendTrack(trackInfo) {
            let track = $("<p>");
        }

        function displayQR() {
            let guestURL = 'http://localhost:5500/guest.html';
            var queryURL = "http://api.qrserver.com/v1/create-qr-code/?data=" + guestURL + "&size=200x200";
            $("#qr-code").attr("src", queryURL);
        }

        function initializePlayer() {
            player = new Spotify.Player({
                name: 'Mixtape Web Player',
                getOAuthToken: cb => { cb(config.token); }
            });

            // Error handling
            player.addListener('initialization_error', ({ message }) => { console.error(message); });
            player.addListener('authentication_error', ({ message }) => { console.error(message); });
            player.addListener('account_error', ({ message }) => { console.error(message); });
            player.addListener('playback_error', ({ message }) => { console.error(message); });

            // Playback status updates
            player.addListener('player_state_changed', state => {
                console.log("Player state changed", state);
                let currentTrack = state.track_window.current_track;
                let artist = currentTrack.artists.map(({ name }) => name).join(', ');

                let status = {
                    duration: state.duration,
                    paused: state.paused,
                    position: state.position,
                    song: currentTrack.name,
                    artist
                }

                console.log(status);
                if (currentTrackId != currentTrack.id) {
                    resetDownvotes();
                }
                currentTrackId = currentTrack.id
                updatePlayerStatus(status);
            });

            // Ready
            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                playerId = device_id;
            });

            // Not Ready
            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
            });

            // Connect to the player!
            player.connect();
        }

        function resetDownvotes() {
            DOWNVOTES_REF.set({});
        }

        $("#play-pause").click(function () {
            player.getCurrentState().then(state => {
                if (!state) {
                    firstPlay();
                } else {
                    player.togglePlay();
                }
            });
            $(this).toggleClass("playing");
            if ($(this).hasClass("playing")) {
                $(this).text("Pause");
            } else {
                $(this).text("Play");
            }
        });

        function firstPlay() {
            $.ajax({
                url: "https://api.spotify.com/v1/me/player/play?device_id=" + playerId,
                method: 'PUT',
                data: JSON.stringify({
                    context_uri: playlistUri
                }),
                success: function (data, status) {
                    console.log(data);
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + config.token);
                }
            });
        }
    </script>
</body>

</html>