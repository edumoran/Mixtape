<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <title>Guest</title>
  <style>
    html, body {
      height: 100%;
    }

    header {
      background: #00B8D1;
      padding: 25px;
    }

    main {
      border: 1px solid;
      height: 100%;
      position: relative;
    }

    footer {
      padding: 10px;
      text-align: center;
    }

    ::-webkit-input-placeholder {
   text-align: center;
    }

    :-moz-placeholder { /* Firefox 18- */
      text-align: center;  
    }

    ::-moz-placeholder {  /* Firefox 19+ */
      text-align: center;  
    }

    :-ms-input-placeholder {  
      text-align: center; 
    }

  </style>
</head>

<body>
  <div class="container p-2" style="max-width:550px; background-color:#38bbd3; color:white;">
    <section class="row mb-3 pl-2 pr-2">
      <div class="col-12"><p class="mb-0">Playlist</p></div>
      <div class="col-12"><h3 id="playlist-name"></h3></div>
    </section>
    <section class="row mb-3 pl-2 pr-2">
      <img id="album-art" class="col-4 img-fluid" src="http://placehold.it/50x50" alt="album-cover">
      <div class="col-8">
        <div class="row">
          <div class="col-12"><h3 id="song-playing"></h3></div>
          <div class="col-12"><p id="artist-playing"></p></div>
          <div class="col-12"><button class="w-100 btn btn-danger rounded" id="downvote">NEXT SONG, PLEASE!</button></div>
        </div>
      </div>
    </section>
  </div>
  <div class="container p-2" style="max-width:550px; background-color:gray;">
    <section class="row mt-2 pl-2 pr-2">
      <div class="col-12">
        <form id="search-form">
          <input class="w-100 rounded" id="search" type="text" placeholder="SEARCH FOR ARTIST OR SONG"></input>
        </form>
      </div>
    </section>
    <section class="row mb-3 pl-2 pr-2">
      <div id="search-results"></div>
    </section>
    <footer>
      <img class="align-self-center" src="http://placehold.it/50x50" alt="Generic placeholder image">
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.5.3/firebase.js"></script>
  <script src="assets/javascript/database.js"></script>
  <script>
    const CONFIG_REF = firebase.database().ref("config");
    const DOWNVOTES_REF = firebase.database().ref("downvotes");
    const PLAYER_REF = firebase.database().ref("player");
    const PLAYLIST_REF = firebase.database().ref("playlist");
    var config = undefined;
    var paused = false;

    $(document).ready(() => {
      loadConfig();
      listenToDownvotes();
      listenToPlayerStatus();
    });

    function loadConfig() {
      CONFIG_REF.once("value", function (snapshot) {
        if (snapshot.val()) {
          config = snapshot.val();
          bindAddToPlaylist();
          bindDownvote();
          bindSearchForm();
          getPlaylistInfo();
        }
      });
    }

    function listenToDownvotes() {
      DOWNVOTES_REF.on("value", function (downvotesSnapshot) {
        $("#downvotes").text(downvotesSnapshot.numChildren());
      });
    }

    function bindSearchForm() {
      $("#search-form").submit(function (e) {
        e.preventDefault();

        let query = $("#search").val().trim();

        $("#search-results").empty();

        $.ajax({
          url: "https://api.spotify.com/v1/search",
          method: "GET",
          data: {
            q: query,
            type: "track"
          },
          beforeSend: function (xhr, settings) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + config.token);
          },

          success: (response) => {
            let tracks = response.tracks;
            $.each(tracks.items, function (index, trackInfo) {
              appendTrack("#search-results", trackInfo)
            });
          }
        });

      });
    }

    function appendTrack(container_selector, trackInfo) {
      console.log(trackInfo);
      let albumImage = trackInfo.album.images[2].url;
      let artist = trackInfo.artists.map(({ name }) => name).join(', ');

      let trackTemplate = $("<p>")
        .addClass("track")
        .append($("<img>").attr("src", albumImage))
        .append($("<span>").html(trackInfo.name + " <br/><i>" + artist + "</i>"))
        .append(
          $(
            "<button>",
            {
              class: 'add-to-playlist',
              "data-uri": trackInfo.uri,
              text: 'Add to playlist',
            }
          )
        );

      $(container_selector).append(trackTemplate);
    }

    function listenToPlayerStatus() {
      PLAYER_REF.on("value", function (playerSnapshot) {
        if (playerSnapshot.val()) {
          let playerStatus = playerSnapshot.val().paused ? 'Paused' : 'Playing';

          paused = playerSnapshot.val().paused;

          $("#song-playing").text(`${playerSnapshot.val().song}`)
          $("#artist-playing").text(`${playerSnapshot.val().artist}`)
          $("#player-status").text(playerStatus);

        } else {
          PLAYER_REF.set({
            paused: true
          });
        }
      });
    }

    function bindAddToPlaylist() {
      $(document).on("click", ".add-to-playlist", function (e) {
        let uri = $(this).attr("data-uri");
        addTrackToSpotifyPlaylist(uri);
      });
    }

    function addTrackToSpotifyPlaylist(uri) {
      $.ajax({
        url: "https://api.spotify.com/v1/playlists/" + config.spotifyPlaylistId + "/tracks",
        method: "POST",
        data: JSON.stringify({
          uris: [uri]
        }),
        beforeSend: function (xhr, settings) {
          xhr.setRequestHeader('Authorization', 'Bearer ' + config.token);
        },

        success: (response) => {
          PLAYLIST_REF.push({
            uri: uri,
            created_at: firebase.database.ServerValue.TIMESTAMP
          });
        }
      });
    }

    function getPlaylistInfo() {
      $.ajax({
          url: "https://api.spotify.com/v1/playlists/" + config.spotifyPlaylistId,
          method: 'GET',
          success: function (data, status) {
              console.log(data);
              playlistUri = data.uri;
              $("#playlist-name").text(data.name);
              $("#album-art").attr("src", albumInfo.images[2].url)
          },

          beforeSend: function (xhr, settings) {
              xhr.setRequestHeader('Authorization', 'Bearer ' + config.token);
          }
      });
    };

    function bindDownvote() {
      $("#downvote").click(function (e) {
        e.preventDefault();
        if (!paused) {
          DOWNVOTES_REF.push({ created_at: firebase.database.ServerValue.TIMESTAMP })
        } else {
          console.log("Click does nothing");
        }
      });
    }
  </script>
</body>

</html>